# Bridge2 合约部署指南

本指南将帮助你在 Arbitrum Sepolia 测试网络上部署和验证 Bridge2 合约。

## 前置准备

### 1. 安装依赖

```bash
pnpm install
```

### 2. 配置环境变量

复制环境变量模板并配置：

```bash
cp env.example .env
```

编辑 `.env` 文件，填入以下必需参数：

#### 必填参数：

**PRIVATE_KEY**: 你的部署账户私钥（需要 0x 前缀）
  - ⚠️ 确保该账户有足够的 Arbitrum Sepolia ETH 用于支付 gas

**ARBISCAN_API_KEY**: Arbiscan API 密钥（用于合约验证）
  - 获取地址: https://arbiscan.io/myapikey

#### Bridge2 构造函数参数：

**HOT_VALIDATOR_ADDRESSES**: Hot 验证者地址列表（逗号分隔）
**COLD_VALIDATOR_ADDRESSES**: Cold 验证者地址列表（逗号分隔）
**VALIDATOR_POWERS**: 验证者权重列表（逗号分隔，需要与地址数量一致）
**USDC_ADDRESS**: USDC 代币地址：Arbitrum Sepolia USDC: `0x75faf114eafb1BDbe2F0316DF893fd58CE46AA4d`
**DISPUTE_PERIOD_SECONDS**: 争议期（秒），例如 86400（1天）
**BLOCK_DURATION_MILLIS**: 区块持续时间（毫秒），默认 250
**LOCKER_THRESHOLD**: Locker 阈值，默认 2

#### 可选参数：

**ARBITRUM_SEPOLIA_RPC_URL**: 自定义 RPC URL（默认使用公共 RPC）

### 3. 配置示例

```env
# 部署账户私钥
PRIVATE_KEY=your_private_key_with_0x_prefix

# Arbiscan API Key
ARBISCAN_API_KEY=YOUR_ARBISCAN_API_KEY

# 验证者配置（示例）
HOT_VALIDATOR_ADDRESSES=0x1234567890123456789012345678901234567890,0xabcdefabcdefabcdefabcdefabcdefabcdefabcd
COLD_VALIDATOR_ADDRESSES=0x9876543210987654321098765432109876543210,0xfedcbafedcbafedcbafedcbafedcbafedcbafed
VALIDATOR_POWERS=100,100

# USDC 地址
USDC_ADDRESS=0x75faf114eafb1BDbe2F0316DF893fd58CE46AA4d

# 其他参数
DISPUTE_PERIOD_SECONDS=86400
BLOCK_DURATION_MILLIS=250
LOCKER_THRESHOLD=2
```

## 部署步骤

### 方式一：部署 + 自动验证（推荐）

一键部署并验证合约：

```bash
pnpm run deploy:arbitrum-sepolia:verify
```

### 方式二：仅部署

仅部署合约，不验证：

```bash
pnpm run deploy:arbitrum-sepolia
```

### 方式三：后续单独验证

如果之前部署时没有验证，可以使用以下命令单独验证：

```bash
pnpm run verify:arbitrum-sepolia <合约地址> <构造函数参数>
```

## 部署后验证

### 1. 查看部署信息

部署成功后，Hardhat Ignition 会在 `ignition/deployments` 目录下保存部署信息，包括：
- 合约地址
- 部署交易哈希
- 构造函数参数

### 2. 在 Arbiscan 查看合约

访问 Arbitrum Sepolia Arbiscan 查看你的合约：

```
https://sepolia.arbiscan.io/address/<你的合约地址>
```

### 3. 验证合约状态

确认合约已经正确验证（绿色对勾 ✓）并且源代码可见。

## 常见问题

### 1. 部署失败：余额不足

**错误信息**: `insufficient funds for gas * price + value`

**解决方案**: 
- 访问 [Arbitrum Sepolia Faucet](https://faucet.quicknode.com/arbitrum/sepolia) 获取测试 ETH
- 或者使用其他水龙头如 https://faucet.triangleplatform.com/arbitrum/sepolia

### 2. 验证失败：API Key 无效

**错误信息**: `Invalid API Key`

**解决方案**: 
- 确保在 https://arbiscan.io/ 注册账户
- 生成 API Key 并正确配置在 `.env` 文件中

### 3. 构造函数参数不匹配

**错误信息**: `constructor arguments do not match`

**解决方案**:
- 检查 `.env` 文件中的参数配置
- 确保验证者地址和权重数量一致
- 确保地址格式正确（以 0x 开头的 42 字符）

### 4. 网络连接问题

**错误信息**: `network timeout` 或 `connection refused`

**解决方案**:
- 检查网络连接
- 尝试使用自定义 RPC URL（如 Alchemy、Infura）
- 在 `.env` 中配置 `ARBITRUM_SEPOLIA_RPC_URL`

## 网络信息

- **网络名称**: Arbitrum Sepolia
- **Chain ID**: 421614
- **RPC URL**: https://sepolia-rollup.arbitrum.io/rpc
- **区块浏览器**: https://sepolia.arbiscan.io
- **水龙头**: https://faucet.quicknode.com/arbitrum/sepolia

## 安全注意事项

⚠️ **重要提醒**:

1. **永远不要**提交包含真实私钥的 `.env` 文件到 Git
2. `.env` 文件已在 `.gitignore` 中，请确保不要移除
3. 测试网私钥也应妥善保管
4. 部署到主网前，请在测试网充分测试
5. 主网部署时，建议使用硬件钱包或多签钱包

## 其他命令

```bash
# 编译合约
pnpm run build

# 运行测试
pnpm run test

# 清理构建文件
pnpm run clean

# 展平合约（用于手动验证）
pnpm run flatten
```

## 获取帮助

如果遇到问题，可以：

1. 查看 Hardhat 文档: https://hardhat.org/docs
2. 查看 Arbitrum 文档: https://docs.arbitrum.io/
3. 查看项目 README.md
4. 提交 Issue 到项目仓库

